AWSTemplateFormatVersion: 2010-09-09
Parameters:
  EnvName:
    Type: String
  DbStorageGbs:
    Type: String
    Default: 20
  DbBackupDays:
    Type: String
    Default: 7
  DbInstanceClass:
    Type: String
    Default: db.t2.small
  DbMultiAz:
    Type: String
    AllowedValues:
      - true
      - false
    Default: false
  DbAdminPassword:
    Type: String
    NoEcho: true
  WebInstanceType:
    Type: String
    Default: t2.micro

Resources:
  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub ${EnvName}-Db
      DBSubnetGroupDescription: DB Subnet Group
      SubnetIds:
        - subnet-19bfcb7f
        - subnet-f5c054bd
        - subnet-4097a11b

  DbAccessSg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvName}-DbAccess
      GroupDescription: DB Access Security Group
      VpcId: vpc-172f0c71

  DbSg:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${EnvName}-Db
      GroupDescription: DB Security Group
      VpcId: vpc-172f0c71
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref DbAccessSg

  Db:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: !Ref DbStorageGbs
      BackupRetentionPeriod: !Ref DbBackupDays
      CopyTagsToSnapshot: true
      DBInstanceClass: !Ref DbInstanceClass
      DBInstanceIdentifier: !Sub ${EnvName}-Db
      DBName: ebdb
      DBSubnetGroupName: !Ref DbSubnetGroup
      Engine: mysql
      EngineVersion: 5.7.21
      MasterUsername: Admin
      MasterUserPassword: !Ref DbAdminPassword
      MultiAZ: !Ref DbMultiAz
      StorageEncrypted: true
      StorageType: gp2
      VPCSecurityGroups:
        - !Ref DbSg

  EbApp:
    Type: AWS::ElasticBeanstalk::Application
    Properties:
      ApplicationName: TestApp

  EbInstanceProfileRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2008-10-17
        Statement:
        - Effect: Allow
          Principal:
            Service: ec2.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSElasticBeanstalkWebTier

  EbInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EbInstanceProfileRole

  DevEnv:
    Type: AWS::ElasticBeanstalk::Environment
    Properties:
      ApplicationName: !Ref EbApp
      EnvironmentName: Development
      SolutionStackName: 64bit Amazon Linux 2018.03 v2.7.0 running PHP 7.1
      Tier:
        Name: WebServer
        Type: Standard
      OptionSettings:
        - Namespace: "aws:autoscaling:launchconfiguration"
          OptionName: IamInstanceProfile
          Value: !Ref EbInstanceProfile
        - Namespace: "aws:autoscaling:launchconfiguration"
          OptionName: EC2KeyName
          Value: jjk3@nimbusscale.com
        - Namespace: "aws:autoscaling:launchconfiguration"
          OptionName: InstanceType
          Value: !Ref WebInstanceType





